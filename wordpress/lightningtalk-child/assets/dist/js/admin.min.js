/**
 * Lightning Talk WordPress Admin Scripts
 * WordPressç®¡ç†ç”»é¢ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 */

(function($) {
    'use strict';

    /**
     * Lightning Talkç®¡ç†ç”»é¢æ©Ÿèƒ½
     */
    class LightningTalkAdmin {
        constructor() {
            this.init();
        }

        init() {
            // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
            $(document).ready(() => {
                this.setupEventManagement();
                this.setupParticipantManagement();
                this.setupTalkManagement();
                this.setupCustomFields();
                this.setupPreview();
                this.setupExport();
                this.setupNotifications();
            });
        }

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã®è¨­å®š
         */
        setupEventManagement() {
            // ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†ç”»é¢ã§ã®æ©Ÿèƒ½
            if (window.pagenow === 'lt_event') {
                this.initEventEditor();
            }
        }

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®åˆæœŸåŒ–
         */
        initEventEditor() {
            // æ—¥æ™‚ãƒ”ãƒƒã‚«ãƒ¼ã®è¨­å®š
            this.setupDateTimePicker();
            
            // ä¼šå ´æƒ…å ±ã®å‹•çš„å…¥åŠ›
            this.setupVenueFields();
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‚åŠ è¨­å®š
            this.setupOnlineSettings();
            
            // å®šå“¡ç®¡ç†
            this.setupCapacityManagement();
        }

        /**
         * æ—¥æ™‚ãƒ”ãƒƒã‚«ãƒ¼ã®è¨­å®š
         */
        setupDateTimePicker() {
            $('#event_date').datetimepicker({
                dateFormat: 'yy-mm-dd',
                timeFormat: 'HH:mm:ss',
                stepMinute: 5,
                onSelect: (dateText) => {
                    this.updateEventPreview();
                }
            });

            $('#event_end_date').datetimepicker({
                dateFormat: 'yy-mm-dd',
                timeFormat: 'HH:mm:ss',
                stepMinute: 5
            });
        }

        /**
         * ä¼šå ´æƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨­å®š
         */
        setupVenueFields() {
            $('#venue_type').change((e) => {
                const venueType = $(e.target).val();
                
                if (venueType === 'online') {
                    $('#physical_venue_fields').hide();
                    $('#online_venue_fields').show();
                } else if (venueType === 'hybrid') {
                    $('#physical_venue_fields').show();
                    $('#online_venue_fields').show();
                } else {
                    $('#physical_venue_fields').show();
                    $('#online_venue_fields').hide();
                }
            });
        }

        /**
         * ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨­å®šã®ç®¡ç†
         */
        setupOnlineSettings() {
            $('#enable_online').change((e) => {
                if ($(e.target).is(':checked')) {
                    $('#online_settings').show();
                } else {
                    $('#online_settings').hide();
                }
            });

            // Google Meet URLã®è‡ªå‹•ç”Ÿæˆ
            $('#generate_meet_url').click((e) => {
                e.preventDefault();
                this.generateMeetUrl();
            });
        }

        /**
         * å®šå“¡ç®¡ç†ã®è¨­å®š
         */
        setupCapacityManagement() {
            $('#max_participants').on('input', () => {
                this.updateCapacityIndicator();
            });
        }

        /**
         * å‚åŠ è€…ç®¡ç†æ©Ÿèƒ½ã®è¨­å®š
         */
        setupParticipantManagement() {
            if (window.pagenow === 'lightningtalk_page_lightningtalk-participants') {
                this.initParticipantManager();
            }
        }

        /**
         * å‚åŠ è€…ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
         */
        initParticipantManager() {
            // å‚åŠ è€…ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­å®š
            $('#participants-table').DataTable({
                pageLength: 25,
                order: [[3, 'desc']], // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆ
                columnDefs: [
                    { orderable: false, targets: [4] } // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ã¯éã‚½ãƒ¼ãƒˆ
                ],
                language: {
                    "processing": "å‡¦ç†ä¸­...",
                    "search": "æ¤œç´¢:",
                    "lengthMenu": "_MENU_ ä»¶è¡¨ç¤º",
                    "info": "_START_ ã‹ã‚‰ _END_ ã¾ã§ï¼ˆå…¨ _TOTAL_ ä»¶ï¼‰",
                    "infoEmpty": "0 ã‹ã‚‰ 0 ã¾ã§ï¼ˆå…¨ 0 ä»¶ï¼‰",
                    "infoFiltered": "ï¼ˆå…¨ _MAX_ ä»¶ã‚ˆã‚ŠæŠ½å‡ºï¼‰",
                    "infoPostFix": "",
                    "loadingRecords": "èª­ã¿è¾¼ã¿ä¸­...",
                    "zeroRecords": "ä¸€è‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“",
                    "emptyTable": "ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“",
                    "paginate": {
                        "first": "å…ˆé ­",
                        "previous": "å‰",
                        "next": "æ¬¡",
                        "last": "æœ€çµ‚"
                    },
                    "aria": {
                        "sortAscending": ": åˆ—ã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã‚‹",
                        "sortDescending": ": åˆ—ã‚’é™é †ã«ä¸¦ã³æ›¿ãˆã‚‹"
                    }
                }
            });

            // ä¸€æ‹¬æ“ä½œã®è¨­å®š
            this.setupBulkActions();
            
            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            this.setupCSVExport();
            
            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½
            this.setupEmailFeatures();
        }

        /**
         * ä¸€æ‹¬æ“ä½œã®è¨­å®š
         */
        setupBulkActions() {
            $('#bulk-action-apply').click((e) => {
                e.preventDefault();
                const action = $('#bulk-action-selector').val();
                const selected = $('input[name="participants[]"]:checked');
                
                if (selected.length === 0) {
                    alert('å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                switch (action) {
                    case 'approve':
                        this.bulkApprove(selected);
                        break;
                    case 'reject':
                        this.bulkReject(selected);
                        break;
                    case 'delete':
                        this.bulkDelete(selected);
                        break;
                    case 'export':
                        this.bulkExport(selected);
                        break;
                }
            });
        }

        /**
         * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®è¨­å®š
         */
        setupCSVExport() {
            $('#export-csv').click((e) => {
                e.preventDefault();
                const eventId = $('#event-filter').val();
                this.exportToCSV(eventId);
            });
        }

        /**
         * ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ã®è¨­å®š
         */
        setupEmailFeatures() {
            $('#send-reminder-email').click((e) => {
                e.preventDefault();
                const eventId = $('#event-filter').val();
                this.sendReminderEmails(eventId);
            });
        }

        /**
         * ç™ºè¡¨ç®¡ç†æ©Ÿèƒ½ã®è¨­å®š
         */
        setupTalkManagement() {
            if (window.pagenow === 'lt_talk') {
                this.initTalkEditor();
            }
        }

        /**
         * ç™ºè¡¨ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®åˆæœŸåŒ–
         */
        initTalkEditor() {
            // ç™ºè¡¨æ™‚é–“ã®è¨­å®š
            this.setupTalkDuration();
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†
            this.setupTalkCategories();
            
            // ç™ºè¡¨è€…æƒ…å ±ã®è‡ªå‹•å…¥åŠ›
            this.setupSpeakerAutoComplete();
        }

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨­å®š
         */
        setupCustomFields() {
            // æ¡ä»¶ä»˜ãè¡¨ç¤ºã®è¨­å®š
            this.setupConditionalFields();
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            this.setupFieldValidation();
            
            // ãƒ¡ã‚¿ãƒœãƒƒã‚¯ã‚¹ã®ç®¡ç†
            this.setupMetaBoxes();
        }

        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®è¨­å®š
         */
        setupPreview() {
            $('#lt-preview-button').click((e) => {
                e.preventDefault();
                this.openPreviewModal();
            });
        }

        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         */
        openPreviewModal() {
            const eventData = this.collectEventData();
            const previewHTML = this.generatePreviewHTML(eventData);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆã—ã¦è¡¨ç¤º
            const modal = $(`
                <div id="lt-preview-modal" class="lt-modal">
                    <div class="lt-modal-content">
                        <span class="lt-close">&times;</span>
                        <h2>ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                        <div class="lt-preview-content">
                            ${previewHTML}
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            modal.show();
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®è¨­å®š
            modal.find('.lt-close').click(() => {
                modal.remove();
            });
        }

        /**
         * ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®è¨­å®š
         */
        setupExport() {
            $('#export-participants').click((e) => {
                e.preventDefault();
                this.exportParticipants();
            });
        }

        /**
         * é€šçŸ¥æ©Ÿèƒ½ã®è¨­å®š
         */
        setupNotifications() {
            // æˆåŠŸ/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            this.showAdminNotices();
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã®è¨­å®š
            this.setupRealTimeNotifications();
        }

        /**
         * Google Meet URLç”Ÿæˆ
         */
        generateMeetUrl() {
            // ä»®ã®Google Meet URLç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªAPIã‚’ä½¿ç”¨ï¼‰
            const randomString = Math.random().toString(36).substring(2, 15);
            const meetUrl = `https://meet.google.com/${randomString}`;
            
            $('#online_url').val(meetUrl);
            this.showNotification('Google Meet URLã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚', 'success');
        }

        /**
         * å®¹é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
         */
        updateCapacityIndicator() {
            const maxParticipants = parseInt($('#max_participants').val()) || 0;
            const currentParticipants = parseInt($('#current_participants').text()) || 0;
            const percentage = maxParticipants > 0 ? (currentParticipants / maxParticipants) * 100 : 0;
            
            $('#capacity-indicator .capacity-bar').css('width', `${percentage}%`);
            $('#capacity-percentage').text(`${Math.round(percentage)}%`);
            
            // 80%ã‚’è¶…ãˆãŸå ´åˆã®è­¦å‘Š
            if (percentage > 80) {
                $('#capacity-indicator').addClass('warning');
            } else {
                $('#capacity-indicator').removeClass('warning');
            }
        }

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®åé›†
         */
        collectEventData() {
            return {
                title: $('#title').val(),
                date: $('#event_date').val(),
                venue: $('#venue_name').val(),
                venueAddress: $('#venue_address').val(),
                onlineUrl: $('#online_url').val(),
                capacity: $('#max_participants').val(),
                description: $('#content').val()
            };
        }

        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã®ç”Ÿæˆ
         */
        generatePreviewHTML(eventData) {
            return `
                <div class="lt-event-card">
                    <div class="date-highlight">
                        ğŸ“… ${eventData.date}
                    </div>
                    <h3>${eventData.title}</h3>
                    
                    <div class="venue-status">
                        <h4>ğŸ“ ä¼šå ´ã«ã¤ã„ã¦</h4>
                        <p><strong>${eventData.venue}</strong></p>
                        <p>${eventData.venueAddress}</p>
                    </div>

                    <div class="online-info">
                        <h4>ğŸ’» ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‚åŠ ã‚‚å¯èƒ½ï¼</h4>
                        <p><strong>Google Meet:</strong> <a href="${eventData.onlineUrl}" target="_blank">å‚åŠ ãƒªãƒ³ã‚¯</a></p>
                    </div>

                    <div class="description">
                        ${eventData.description}
                    </div>
                </div>
            `;
        }

        /**
         * ä¸€æ‹¬æ‰¿èª
         */
        bulkApprove(selected) {
            const participantIds = selected.map(function() {
                return $(this).val();
            }).get();
            
            this.performBulkAction('approve', participantIds, 'å‚åŠ è€…ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚');
        }

        /**
         * ä¸€æ‹¬å‰Šé™¤
         */
        bulkDelete(selected) {
            if (!confirm('é¸æŠã—ãŸå‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            const participantIds = selected.map(function() {
                return $(this).val();
            }).get();
            
            this.performBulkAction('delete', participantIds, 'å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }

        /**
         * ä¸€æ‹¬æ“ä½œã®å®Ÿè¡Œ
         */
        performBulkAction(action, ids, successMessage) {
            $.ajax({
                url: ajaxurl,
                method: 'POST',
                data: {
                    action: `lightningtalk_bulk_${action}`,
                    participant_ids: ids,
                    nonce: lightningtalk_admin.nonce
                },
                success: (response) => {
                    if (response.success) {
                        this.showNotification(successMessage, 'success');
                        location.reload();
                    } else {
                        this.showNotification('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    }
                },
                error: () => {
                    this.showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                }
            });
        }

        /**
         * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
         */
        exportToCSV(eventId) {
            window.location.href = `${ajaxurl}?action=lightningtalk_export_csv&event_id=${eventId}&nonce=${lightningtalk_admin.nonce}`;
        }

        /**
         * ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«é€ä¿¡
         */
        sendReminderEmails(eventId) {
            $.ajax({
                url: ajaxurl,
                method: 'POST',
                data: {
                    action: 'lightningtalk_send_reminder',
                    event_id: eventId,
                    nonce: lightningtalk_admin.nonce
                },
                success: (response) => {
                    if (response.success) {
                        this.showNotification(`${response.data.sent_count}ä»¶ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`, 'success');
                    } else {
                        this.showNotification('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    }
                }
            });
        }

        /**
         * é€šçŸ¥ã®è¡¨ç¤º
         */
        showNotification(message, type = 'info') {
            const notification = $(`
                <div class="notice notice-${type} is-dismissible">
                    <p>${message}</p>
                </div>
            `);
            
            $('.wrap h1').after(notification);
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆå»
            setTimeout(() => {
                notification.fadeOut();
            }, 3000);
        }

        /**
         * ç®¡ç†ç”»é¢é€šçŸ¥ã®è¡¨ç¤º
         */
        showAdminNotices() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰é€šçŸ¥ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('lt_message');
            const type = urlParams.get('lt_type') || 'success';
            
            if (message) {
                this.showNotification(decodeURIComponent(message), type);
            }
        }

        /**
         * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã®è¨­å®š
         */
        setupRealTimeNotifications() {
            // WebSocketæ¥ç¶šï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
            // this.connectWebSocket();
        }
    }

    // Lightning Talkç®¡ç†æ©Ÿèƒ½ã®åˆæœŸåŒ–
    new LightningTalkAdmin();

})(jQuery);
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push hooks..."

# ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
current_branch=$(git rev-parse --abbrev-ref HEAD)
remote=$1
url=$2

echo "ğŸ“ Current branch: $current_branch"
echo "ğŸ“¡ Remote: $remote"
echo "ğŸ”— URL: $url"

# main/masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âš ï¸  Pushing to $current_branch branch - Running comprehensive checks..."
  
  # åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
  echo "ğŸ§ª Running full test suite..."
  npm test
  
  if [ $? -ne 0 ]; then
    echo "âŒ Full test suite failed"
    echo "Cannot push to $current_branch with failing tests"
    exit 1
  fi
  
  # å‹ãƒã‚§ãƒƒã‚¯ï¼ˆTypeScriptï¼‰
  if [ -f "tsconfig.json" ] || [ -f "lightningtalk-modern/tsconfig.json" ]; then
    echo "ğŸ” Running TypeScript type check..."
    
    if [ -f "lightningtalk-modern/package.json" ]; then
      cd lightningtalk-modern && npm run type-check
      type_check_result=$?
      cd ..
    else
      npx tsc --noEmit
      type_check_result=$?
    fi
    
    if [ $type_check_result -ne 0 ]; then
      echo "âŒ TypeScript type check failed"
      echo "Cannot push to $current_branch with type errors"
      exit 1
    fi
  fi
  
  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  echo "ğŸ—ï¸  Testing build process..."
  
  if [ -f "lightningtalk-modern/package.json" ]; then
    cd lightningtalk-modern && npm run build
    build_result=$?
    cd ..
    
    if [ $build_result -ne 0 ]; then
      echo "âŒ Modern WordPress build failed"
      echo "Cannot push to $current_branch with build errors"
      exit 1
    fi
  fi
  
  # WordPress ãƒ†ãƒ¼ãƒãƒ“ãƒ«ãƒ‰
  if [ -f "gulpfile.js" ]; then
    echo "ğŸ¨ Testing WordPress theme build..."
    npm run wp:build
    
    if [ $? -ne 0 ]; then
      echo "âŒ WordPress theme build failed"
      echo "Cannot push to $current_branch with build errors"
      exit 1
    fi
  fi
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  echo "ğŸ”’ Running security audit..."
  npm audit --audit-level=moderate
  
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Security vulnerabilities detected"
    echo "Consider addressing these before pushing to production"
    echo "Run 'npm audit fix' to auto-fix issues"
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã¯è­¦å‘Šã®ã¿ï¼ˆmain/masterã§ã‚‚é€šã™ï¼‰
  fi
  
else
  echo "ğŸ“ Feature branch detected - Running basic checks..."
  
  # åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
  echo "ğŸ§ª Running unit tests..."
  npm run test:unit -- --passWithNoTests
  
  if [ $? -ne 0 ]; then
    echo "âŒ Unit tests failed"
    echo "Please fix failing tests before pushing"
    exit 1
  fi
fi

# ãƒªãƒ¢ãƒ¼ãƒˆè¿½è·¡ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
echo "ğŸ“Š Checking differences with remote..."
remote_branch="$remote/$current_branch"

if git rev-parse --verify "$remote_branch" >/dev/null 2>&1; then
  commits_ahead=$(git rev-list --count "$remote_branch..$current_branch")
  commits_behind=$(git rev-list --count "$current_branch..$remote_branch")
  
  echo "ğŸ“ˆ Commits ahead: $commits_ahead"
  echo "ğŸ“‰ Commits behind: $commits_behind"
  
  if [ "$commits_behind" -gt 0 ]; then
    echo "âš ï¸  Warning: Your branch is $commits_behind commits behind $remote_branch"
    echo "Consider pulling latest changes before pushing"
    
    # main/masterãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯å¼·åˆ¶çš„ã«åœæ­¢
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
      echo "âŒ Cannot push to $current_branch when behind remote"
      echo "Please pull and merge/rebase first"
      exit 1
    fi
  fi
else
  echo "ğŸ“¤ New branch - first push"
fi

# å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Checking for large files..."
large_files=$(git diff --cached --name-only | xargs -I {} find {} -size +10M 2>/dev/null || true)

if [ ! -z "$large_files" ]; then
  echo "âš ï¸  Warning: Large files detected (>10MB):"
  echo "$large_files"
  echo "Consider using Git LFS for large files"
fi

# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ç§˜å¯†æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Checking for sensitive files..."
sensitive_patterns="\.env$|\.env\.|id_rsa|private\.key|\.pem$|password|secret|token"
sensitive_files=$(git diff --cached --name-only | grep -E "$sensitive_patterns" || true)

if [ ! -z "$sensitive_files" ]; then
  echo "âŒ Sensitive files detected in commit:"
  echo "$sensitive_files"
  echo "These files should not be committed to version control"
  exit 1
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Ready to push to $remote/$current_branch"
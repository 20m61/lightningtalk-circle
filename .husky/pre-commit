# !/usr/bin/env sh
# . "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit hooks..."

# ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$staged_files" ]; then
  echo "âœ… No staged files to check"
  exit 0
fi

echo "ğŸ“ Staged files: $staged_files"

# JavaScript/TypeScript/JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿
js_files=$(echo "$staged_files" | grep -E '\.(js|ts|jsx|tsx|json)$' || true)
css_files=$(echo "$staged_files" | grep -E '\.(css|scss|sass|less)$' || true)
md_files=$(echo "$staged_files" | grep -E '\.md$' || true)

# ESLint ãƒã‚§ãƒƒã‚¯ï¼ˆJavaScript/TypeScript ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
if [ ! -z "$js_files" ]; then
  echo "ğŸ”§ Running ESLint on JavaScript/TypeScript files..."
  echo "$js_files" | xargs npx eslint --fix --quiet
  
  if [ $? -ne 0 ]; then
    echo "âŒ ESLint found issues that couldn't be automatically fixed"
    echo "Please fix the issues and commit again"
    exit 1
  fi
  
  # ESLint ã§ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¹ãƒ†ãƒ¼ã‚¸
  echo "$js_files" | xargs git add
  echo "âœ… ESLint completed"
fi

# Prettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå…¨å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
if [ ! -z "$staged_files" ]; then
  echo "ğŸ¨ Running Prettier formatting..."
  echo "$staged_files" | xargs npx prettier --write --loglevel=warn
  
  if [ $? -ne 0 ]; then
    echo "âŒ Prettier formatting failed"
    exit 1
  fi
  
  # Prettier ã§ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¹ãƒ†ãƒ¼ã‚¸
  echo "$staged_files" | xargs git add
  echo "âœ… Prettier formatting completed"
fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆNode.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼‰
if [ -f "package.json" ]; then
  echo "ğŸ§ª Running unit tests..."
  
  # é«˜é€Ÿãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆunit testsï¼‰
  npm run test:unit -- --passWithNoTests --bail
  
  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed"
    echo "Please fix failing tests before committing"
    exit 1
  fi
  
  echo "âœ… Tests passed"
fi

# TypeScript å‹ãƒã‚§ãƒƒã‚¯ï¼ˆTypeScript ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼‰
if [ -f "tsconfig.json" ] || [ -f "lightningtalk-modern/tsconfig.json" ]; then
  echo "ğŸ” Running TypeScript type check..."
  
  if [ -f "lightningtalk-modern/package.json" ]; then
    cd lightningtalk-modern && npm run type-check
    type_check_result=$?
    cd ..
  else
    npx tsc --noEmit
    type_check_result=$?
  fi
  
  if [ $type_check_result -ne 0 ]; then
    echo "âŒ TypeScript type check failed"
    echo "Please fix type errors before committing"
    exit 1
  fi
  
  echo "âœ… TypeScript type check passed"
fi

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆpackage.json ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
if echo "$staged_files" | grep -q "package.json\|package-lock.json\|yarn.lock"; then
  echo "ğŸ”’ Running security audit..."
  
  npm audit --audit-level=high
  
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Security vulnerabilities found"
    echo "Consider running 'npm audit fix' after commit"
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã¯è­¦å‘Šã®ã¿ï¼ˆå¤±æ•—ã•ã›ãªã„ï¼‰
  else
    echo "âœ… Security audit passed"
  fi
fi

echo "ğŸ‰ All pre-commit hooks passed!"
echo "ğŸ’¾ Ready to commit"